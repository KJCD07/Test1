

DECLARE @FolderPath NVARCHAR(500);
DECLARE @Command NVARCHAR(1000);
DECLARE @RowCount INT;

-- Count rows in the source table
SELECT @RowCount = COUNT(*) FROM TableB;

-- If no rows, exit early
IF @RowCount = 0
BEGIN
    PRINT 'No rows found in TableB. Nothing to process.';
    RETURN;
END

-- Cursor definition
DECLARE cur CURSOR LOCAL FAST_FORWARD FOR
    SELECT LTRIM(RTRIM(Column1))  -- trim spaces in paths
    FROM TableB;

OPEN cur;
FETCH NEXT FROM cur INTO @FolderPath;

WHILE @@FETCH_STATUS = 0
BEGIN
    PRINT 'Processing folder: ' + @FolderPath;

    -- Step A: Capture today's files into temp table
    IF OBJECT_ID('tempdb..#Output') IS NOT NULL
        DROP TABLE #Output;

    CREATE TABLE #Output (Line NVARCHAR(500));

    SET @Command = 'cmd /c forfiles /p "' + @FolderPath + '" /s /m *.* /d 0 /c "cmd /c echo @file"';
    INSERT INTO #Output
    EXEC xp_cmdshell @Command;

    -- Step B: Insert found files into log (skip null/error lines)
    INSERT INTO dbo.DeletedFilesLog (FolderPath, FileName)
    SELECT @FolderPath, Line
    FROM #Output
   where Line IS NOT NULL
    -- Step C: Delete today's files
    SET @Command = 'cmd /c forfiles /p "' + @FolderPath + '" /s /m *.* /d 0 /c "cmd /c del @file"';
    EXEC xp_cmdshell @Command;

    -- Next row
    FETCH NEXT FROM cur INTO @FolderPath;
END

CLOSE cur;
DEALLOCATE cur;






































@echo off
setlocal enabledelayedexpansion

:: Step 1: Run SQL query and get the single row with pipe-delimited paths
set DbServer=YourServerName
set DbName=YourDatabase
set OutputFile=C:\Temp\allpaths.txt

sqlcmd -S %DbServer% -d %DbName% -E -Q "SET NOCOUNT ON; SELECT Paths FROM dbo.FilePathData" -h -1 -W > "%OutputFile%"

:: Step 2: Read the line into a variable
set /p Line=<"%OutputFile%"

:: Step 3: Replace | with spaces so we can loop
set Line=%Line:|= %

:: Step 4: Loop through each folder
for %%F in (%Line%) do (
    echo Processing folder: %%F
    if exist "%%F" (
        :: Example: delete files older than 30 days
        forfiles /p "%%F" /s /m *.* /d -30 /c "cmd /c del @file"
    ) else (
        echo Folder does not exist: %%F
    )
)

echo Done.
endlocal

